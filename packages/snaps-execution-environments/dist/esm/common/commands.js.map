{"version":3,"sources":["../../../src/common/commands.ts"],"sourcesContent":["import { HandlerType } from '@metamask/snaps-utils';\nimport { assertExhaustive } from '@metamask/utils';\n\nimport type { InvokeSnap, InvokeSnapArgs } from './BaseSnapExecutor';\nimport type {\n  ExecuteSnap,\n  JsonRpcRequestWithoutId,\n  Ping,\n  PossibleLookupRequestArgs,\n  SnapRpc,\n  Terminate,\n} from './validation';\nimport {\n  assertIsOnTransactionRequestArguments,\n  assertIsOnNameLookupRequestArguments,\n} from './validation';\n\nexport type CommandMethodsMapping = {\n  ping: Ping;\n  terminate: Terminate;\n  executeSnap: ExecuteSnap;\n  snapRpc: SnapRpc;\n};\n\n/**\n * Formats the arguments for the given handler.\n *\n * @param origin - The origin of the request.\n * @param handler - The handler to pass the request to.\n * @param request - The request object.\n * @returns The formatted arguments.\n */\nexport function getHandlerArguments(\n  origin: string,\n  handler: HandlerType,\n  request: JsonRpcRequestWithoutId,\n): InvokeSnapArgs {\n  // `request` is already validated by the time this function is called.\n\n  switch (handler) {\n    case HandlerType.OnTransaction: {\n      assertIsOnTransactionRequestArguments(request.params);\n\n      const { transaction, chainId, transactionOrigin } = request.params;\n      return {\n        transaction,\n        chainId,\n        transactionOrigin,\n      };\n    }\n    case HandlerType.OnNameLookup: {\n      assertIsOnNameLookupRequestArguments(request.params);\n\n      // TS complains that domain/address are not part of the type\n      // casting here as we've already validated the request args in the above step.\n      const { chainId, domain, address } =\n        request.params as unknown as PossibleLookupRequestArgs;\n\n      return domain\n        ? {\n            chainId,\n            domain,\n          }\n        : {\n            chainId,\n            address,\n          };\n    }\n    case HandlerType.OnRpcRequest:\n    case HandlerType.OnKeyringRequest:\n      return { origin, request };\n\n    case HandlerType.OnCronjob:\n    case HandlerType.OnInstall:\n    case HandlerType.OnUpdate:\n      return { request };\n\n    default:\n      return assertExhaustive(handler);\n  }\n}\n\n/**\n * Gets an object mapping internal, \"command\" JSON-RPC method names to their\n * implementations.\n *\n * @param startSnap - A function that starts a snap.\n * @param invokeSnap - A function that invokes the RPC method handler of a\n * snap.\n * @param onTerminate - A function that will be called when this executor is\n * terminated in order to handle cleanup tasks.\n * @returns An object containing the \"command\" method implementations.\n */\nexport function getCommandMethodImplementations(\n  startSnap: (...args: Parameters<ExecuteSnap>) => Promise<void>,\n  invokeSnap: InvokeSnap,\n  onTerminate: () => void,\n): CommandMethodsMapping {\n  return {\n    ping: async () => Promise.resolve('OK'),\n    terminate: async () => {\n      onTerminate();\n      return Promise.resolve('OK');\n    },\n\n    executeSnap: async (snapId, sourceCode, endowments) => {\n      await startSnap(snapId, sourceCode, endowments);\n      return 'OK';\n    },\n\n    snapRpc: async (target, handler, origin, request) => {\n      return (\n        (await invokeSnap(\n          target,\n          handler,\n          getHandlerArguments(origin, handler, request),\n        )) ?? null\n      );\n    },\n  };\n}\n"],"names":["HandlerType","assertExhaustive","assertIsOnTransactionRequestArguments","assertIsOnNameLookupRequestArguments","getHandlerArguments","origin","handler","request","OnTransaction","params","transaction","chainId","transactionOrigin","OnNameLookup","domain","address","OnRpcRequest","OnKeyringRequest","OnCronjob","OnInstall","OnUpdate","getCommandMethodImplementations","startSnap","invokeSnap","onTerminate","ping","Promise","resolve","terminate","executeSnap","snapId","sourceCode","endowments","snapRpc","target"],"mappings":"AAAA,SAASA,WAAW,QAAQ,wBAAwB;AACpD,SAASC,gBAAgB,QAAQ,kBAAkB;AAWnD,SACEC,qCAAqC,EACrCC,oCAAoC,QAC/B,eAAe;AAStB;;;;;;;CAOC,GACD,OAAO,SAASC,oBACdC,MAAc,EACdC,OAAoB,EACpBC,OAAgC;IAEhC,sEAAsE;IAEtE,OAAQD;QACN,KAAKN,YAAYQ,aAAa;YAAE;gBAC9BN,sCAAsCK,QAAQE,MAAM;gBAEpD,MAAM,EAAEC,WAAW,EAAEC,OAAO,EAAEC,iBAAiB,EAAE,GAAGL,QAAQE,MAAM;gBAClE,OAAO;oBACLC;oBACAC;oBACAC;gBACF;YACF;QACA,KAAKZ,YAAYa,YAAY;YAAE;gBAC7BV,qCAAqCI,QAAQE,MAAM;gBAEnD,4DAA4D;gBAC5D,8EAA8E;gBAC9E,MAAM,EAAEE,OAAO,EAAEG,MAAM,EAAEC,OAAO,EAAE,GAChCR,QAAQE,MAAM;gBAEhB,OAAOK,SACH;oBACEH;oBACAG;gBACF,IACA;oBACEH;oBACAI;gBACF;YACN;QACA,KAAKf,YAAYgB,YAAY;QAC7B,KAAKhB,YAAYiB,gBAAgB;YAC/B,OAAO;gBAAEZ;gBAAQE;YAAQ;QAE3B,KAAKP,YAAYkB,SAAS;QAC1B,KAAKlB,YAAYmB,SAAS;QAC1B,KAAKnB,YAAYoB,QAAQ;YACvB,OAAO;gBAAEb;YAAQ;QAEnB;YACE,OAAON,iBAAiBK;IAC5B;AACF;AAEA;;;;;;;;;;CAUC,GACD,OAAO,SAASe,gCACdC,SAA8D,EAC9DC,UAAsB,EACtBC,WAAuB;IAEvB,OAAO;QACLC,MAAM,UAAYC,QAAQC,OAAO,CAAC;QAClCC,WAAW;YACTJ;YACA,OAAOE,QAAQC,OAAO,CAAC;QACzB;QAEAE,aAAa,OAAOC,QAAQC,YAAYC;YACtC,MAAMV,UAAUQ,QAAQC,YAAYC;YACpC,OAAO;QACT;QAEAC,SAAS,OAAOC,QAAQ5B,SAASD,QAAQE;YACvC,OACE,AAAC,MAAMgB,WACLW,QACA5B,SACAF,oBAAoBC,QAAQC,SAASC,aACjC;QAEV;IACF;AACF"}